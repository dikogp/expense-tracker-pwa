<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Pengeluaranqu</title>
    <meta
      name="description"
      content="Dashboard keuangan pribadi untuk melacak pengeluaran dan pemasukan"
    />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pengeluaranqu" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/icon-192x192.svg" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.svg" />

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css" />

    <!-- Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';"
    />
  </head>
  <body>
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div id="app">
      <!-- Main Application -->
      <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
          <div class="container">
            <div
              class="logo clickable-logo"
              onclick="window.location.href = 'dashboard.html'"
            >
              <span class="logo-icon">üí∞</span>
              <h1>Pengeluaranqu</h1>
            </div>
            <div class="header-info">
              <div class="user-greeting">
                <span class="greeting-text" id="greetingText"
                  >Selamat datang,</span
                >
                <span class="user-name" id="headerUserName">Pengguna</span>
              </div>
              <!-- Hamburger Menu Button -->
              <button
                class="hamburger-menu"
                onclick="toggleHamburgerMenu()"
                id="hamburgerBtn"
              >
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
              </button>
            </div>
          </div>

          <!-- Hamburger Menu Dropdown -->
          <div class="hamburger-dropdown" id="hamburgerDropdown">
            <div class="hamburger-menu-content">
              <a href="dashboard.html" class="hamburger-menu-item active">
                <span class="menu-icon">üè†</span>
                <span class="menu-text">Dashboard</span>
              </a>
              <a href="add-transaction.html" class="hamburger-menu-item">
                <span class="menu-icon">‚ûï</span>
                <span class="menu-text">Tambah Transaksi</span>
              </a>
              <a href="history.html" class="hamburger-menu-item">
                <span class="menu-icon">üìã</span>
                <span class="menu-text">Riwayat</span>
              </a>
              <a
                href="analytics.html"
                class="hamburger-menu-item premium-item"
                onclick="checkPremiumFeature('advancedReports')"
              >
                <span class="menu-icon">üìä</span>
                <span class="menu-text">Analisis</span>
                <span class="premium-badge">‚≠ê</span>
              </a>
              <a href="profile.html" class="hamburger-menu-item">
                <span class="menu-icon">üë§</span>
                <span class="menu-text">Profil</span>
              </a>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Dashboard Content -->
          <section id="dashboard" class="tab-content active">
            <div class="container">
              <!-- Dashboard Header with Quick Actions -->
              <div class="dashboard-header">
                <div class="header-content">
                  <div class="header-text">
                    <h1 class="dashboard-title">Financial Overview</h1>
                    <p class="dashboard-subtitle" id="dashboardDate">
                      2 Oktober 2025
                    </p>
                  </div>
                  <div class="header-actions">
                    <button
                      class="action-button secondary"
                      onclick="refreshDashboard()"
                    >
                      <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="23,4 23,10 17,10" />
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                      </svg>
                      Refresh
                    </button>
                    <button
                      class="action-button primary"
                      data-type="expense"
                      data-action="quick-add"
                      onclick="navigateToAddTransaction()"
                    >
                      <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                      </svg>
                      Add Transaction
                    </button>
                  </div>
                </div>
              </div>

              <!-- Key Metrics Cards -->
              <div class="metrics-grid">
                <div class="metric-card balance-card">
                  <div class="metric-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <line x1="12" y1="1" x2="12" y2="23" />
                      <path
                        d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                      />
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h3 class="metric-label">Current Balance</h3>
                    <p class="metric-value primary" id="dashboardBalance">
                      Rp 0
                    </p>
                    <span class="metric-change positive" id="balanceChange"
                      >+0%</span
                    >
                  </div>
                </div>

                <div class="metric-card income-card">
                  <div class="metric-icon success">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="22,12 18,8 14,12" />
                      <path d="M18 8v13a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8" />
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h3 class="metric-label">Monthly Income</h3>
                    <p class="metric-value success" id="monthIncome">Rp 0</p>
                    <span class="metric-change positive" id="incomeChange"
                      >+0%</span
                    >
                  </div>
                </div>

                <div class="metric-card expense-card">
                  <div class="metric-icon danger">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="2,12 6,8 10,12" />
                      <path d="M6 8v13a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8" />
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h3 class="metric-label">Monthly Expenses</h3>
                    <p class="metric-value danger" id="monthExpense">Rp 0</p>
                    <span class="metric-change negative" id="expenseChange"
                      >+0%</span
                    >
                  </div>
                </div>

                <div class="metric-card savings-card">
                  <div class="metric-icon warning">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M12 2l3.09 6.26L22 9l-5 4.87 1.18 6.88L12 17.77l-6.18 2.98L7 14.87 2 9l6.91-1.74z"
                      />
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h3 class="metric-label">Savings Rate</h3>
                    <p class="metric-value warning" id="savingsRate">0%</p>
                    <span class="metric-change neutral" id="savingsChange"
                      >Goal: 20%</span
                    >
                  </div>
                </div>
              </div>

              <!-- Main Dashboard Grid -->
              <div class="dashboard-grid">
                <!-- Enhanced Budget Management Section -->
                <div class="dashboard-section budget-section-redesigned">
                  <div class="section-header-modern">
                    <div class="section-title-group">
                      <div class="section-icon-wrapper">
                        <svg
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          class="section-icon"
                        >
                          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                          <path d="M2 17l10 5 10-5"/>
                          <path d="M2 12l10 5 10-5"/>
                        </svg>
                      </div>
                      <div class="section-title-content">
                        <h2 class="section-title-main">üí∞ Budget Management</h2>
                        <p class="section-subtitle">Track and manage your monthly spending limits</p>
                      </div>
                    </div>
                    <div class="section-actions-modern">
                      <button class="btn-modern-primary" onclick="showBudgetModal()">
                        <svg
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <line x1="12" y1="5" x2="12" y2="19" />
                          <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        <span>Set Budget</span>
                      </button>
                      <button class="btn-modern-secondary" onclick="viewBudgetHistory()">
                        <svg
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path d="M12 8v8l4-4"/>
                          <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.12 0 4.07.74 5.61 1.98"/>
                        </svg>
                        <span>History</span>
                      </button>
                    </div>
                  </div>

                  <div class="budget-content-modern" id="budgetOverview">
                    <!-- Enhanced content will be populated by JavaScript -->
                  </div>
                </div>

                <!-- Charts Section -->
                <div class="dashboard-section chart-section">
                  <div class="section-header">
                    <h2 class="section-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
                      </svg>
                      Financial Analytics
                    </h2>
                    <div class="section-actions">
                      <select class="period-selector" id="chartPeriod">
                        <option value="7d">Last 7 Days</option>
                        <option value="30d" selected>Last 30 Days</option>
                        <option value="90d">Last 3 Months</option>
                        <option value="1y">Last Year</option>
                      </select>
                      <a href="analytics.html" class="link-button">
                        View Details
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path d="M7 17l10-10M17 7H7v10" />
                        </svg>
                      </a>
                    </div>
                  </div>

                  <div class="charts-container">
                    <div class="chart-wrapper">
                      <h4 class="chart-title">Income vs Expenses Trend</h4>
                      <div class="chart-placeholder" id="trendChart">
                        <canvas
                          id="trendChartCanvas"
                          width="400"
                          height="200"
                        ></canvas>
                      </div>
                    </div>

                    <div class="chart-wrapper">
                      <h4 class="chart-title">Expense Categories</h4>
                      <div class="chart-placeholder" id="categoryChart">
                        <canvas
                          id="categoryChartCanvas"
                          width="300"
                          height="200"
                        ></canvas>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="dashboard-section activity-section">
                  <div class="section-header">
                    <h2 class="section-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12,6 12,12 16,14" />
                      </svg>
                      Recent Activity
                    </h2>
                    <a href="history.html" class="link-button">
                      View All
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M7 17l10-10M17 7H7v10" />
                      </svg>
                    </a>
                  </div>

                  <div class="activity-list" id="recentActivity">
                    <!-- Will be populated by JavaScript -->
                  </div>
                </div>

                <!-- Quick Insights Section -->
                <div class="dashboard-section insights-section">
                  <div class="section-header">
                    <h2 class="section-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4m6-6h4a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-4m-6 0a2 2 0 0 0-2-2v-3a2 2 0 0 0 2-2m6 0a2 2 0 0 1 2-2v-3a2 2 0 0 1-2-2"
                        />
                      </svg>
                      Smart Insights
                    </h2>
                    <button class="link-button" onclick="generateInsights()">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="23,4 23,10 17,10" />
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                      </svg>
                      Refresh
                    </button>
                  </div>

                  <div class="insights-content" id="smartInsights">
                    <!-- Will be populated by JavaScript -->
                  </div>
                </div>

                <!-- Profile Integration Section -->
                <div class="dashboard-section profile-section">
                  <div class="section-header">
                    <h2 class="section-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                      </svg>
                      Profile Summary
                    </h2>
                    <a href="profile.html" class="link-button">
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M7 17l10-10M17 7H7v10" />
                      </svg>
                      View Profile
                    </a>
                  </div>

                  <div class="profile-preview" id="profilePreview">
                    <!-- Will be populated by JavaScript -->
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>

        <!-- Floating Refresh Button -->
        <button
          class="dashboard-refresh-btn"
          onclick="refreshDashboard()"
          title="Refresh Dashboard"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M23 4v6h-6M1 20v-6h6" />
            <path
              d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15a9 9 0 0 0 14.85 3.36L23 14"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Modals and other shared content -->
    <div class="modals-container">
      <!-- Budget Modal -->
      <div id="budgetModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Atur Anggaran Bulanan</h2>
            <span class="close-modal" onclick="window.closeModal('budgetModal')"
              >&times;</span
            >
          </div>
          <div class="modal-body">
            <form id="budgetForm">
              <div class="form-group">
                <label for="budget-month">Bulan</label>
                <input type="month" id="budget-month" name="month" required />
              </div>
              <div class="form-group">
                <label for="budget-amount">Jumlah Anggaran</label>
                <input
                  type="text"
                  inputmode="numeric"
                  id="budget-amount"
                  name="budget"
                  placeholder="Contoh: 5000000"
                  required
                />
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn-secondary"
                  onclick="window.closeModal('budgetModal')"
                >
                  Batal
                </button>
                <button type="submit" class="btn-primary">Simpan</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Quick Add Modal -->
      <div id="quickAddModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="quickAddTitle">Tambah Transaksi Cepat</h2>
            <span
              class="close-modal"
              onclick="window.closeModal('quickAddModal')"
              >&times;</span
            >
          </div>
          <div class="modal-body">
            <form id="quickAddForm" novalidate>
              <input
                type="hidden"
                id="quickAddType"
                name="type"
                value="expense"
              />
              <div class="form-group">
                <label for="quickAddAmount">Jumlah</label>
                <input
                  type="text"
                  inputmode="numeric"
                  id="quickAddAmount"
                  name="amount"
                  placeholder="Contoh: 50000"
                  required
                />
              </div>
              <div class="form-group">
                <label for="quickAddCategory">Kategori</label>
                <select id="quickAddCategory" name="category" required></select>
              </div>
              <div class="form-group">
                <label for="quickAddDescription">Deskripsi (Opsional)</label>
                <input
                  type="text"
                  id="quickAddDescription"
                  name="description"
                  placeholder="Makan siang"
                />
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn-secondary"
                  onclick="window.closeModal('quickAddModal')"
                >
                  Batal
                </button>
                <button type="submit" class="btn-primary">Simpan</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Modals will be loaded here -->
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/notification.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>

    <script>
      // Initialize app for dashboard
      document.addEventListener("DOMContentLoaded", function () {
        // Set up service worker
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", function () {
            navigator.serviceWorker
              .register("sw.js")
              .then(function (registration) {
                console.log("SW registered with scope: ", registration.scope);
              })
              .catch(function (err) {
                console.log("SW registration failed: ", err);
              });
          });
        }

        // Ensure ExpenseTracker is loaded before using it
        if (window.ExpenseTracker) {
          window.app = window.ExpenseTracker;
          window.app.init();
          // Show only dashboard section
          window.app.showSection("dashboard");
        } else {
          console.error(
            "ExpenseTracker not found. Make sure app.js is loaded correctly."
          );
          setTimeout(() => {
            if (window.ExpenseTracker) {
              window.app = window.ExpenseTracker;
              window.app.init();
              window.app.showSection("dashboard");
            }
          }, 500); // Try again after a short delay
        }
      });

      // Initialize NotificationSystem if not present
      window.NotificationSystem = window.NotificationSystem || {
        addNotification: function (type, message, amount) {
          console.log("Notification:", type, message, amount);
        },
        init: function () {},
      };

      // Dashboard-specific functions
      function refreshDashboard() {
        if (window.app) {
          console.log("Refreshing dashboard...");
          window.app.updateUI();
          updateDashboardMetrics();
          updateRecentActivity();
          updateBudgetOverview();
          updateSmartInsights();
          updateProfilePreview();

          if (window.app.showToast) {
            window.app.showToast("Dashboard refreshed!", "success");
          } else {
            console.log("Dashboard refreshed!");
          }
        }
      }

      function showBudgetModal() {
        if (window.openModal) {
          window.openModal("budgetModal");
        }
      }

      function generateInsights() {
        updateSmartInsights();
        window.app && window.app.showToast("Insights updated!", "info");
      }

      // New Budget History Function
      function viewBudgetHistory() {
        const budget = JSON.parse(localStorage.getItem("budget") || "{}");
        const transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
        
        let historyHtml = '<div class="budget-history-modal" style="max-height: 400px; overflow-y: auto;">';
        
        if (Object.keys(budget).length === 0) {
          historyHtml += `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
              <p>No budget history found</p>
            </div>
          `;
        } else {
          historyHtml += '<h4 style="margin-bottom: 1rem; color: var(--text-primary);">Budget History</h4>';
          
          // Sort months in descending order
          const sortedMonths = Object.keys(budget).sort((a, b) => b.localeCompare(a));
          
          sortedMonths.forEach(monthKey => {
            const monthBudget = budget[monthKey];
            const [year, month] = monthKey.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            
            // Calculate expenses for this month
            const monthExpenses = transactions.filter(t => {
              const tDate = new Date(t.date);
              return t.type === 'expense' && 
                     tDate.getFullYear().toString() === year && 
                     (tDate.getMonth() + 1).toString().padStart(2, '0') === month;
            }).reduce((sum, t) => sum + t.amount, 0);
            
            const percentage = monthBudget.budget > 0 ? (monthExpenses / monthBudget.budget) * 100 : 0;
            const status = percentage > 100 ? 'Over Budget' : percentage > 80 ? 'Warning' : 'On Track';
            const statusClass = percentage > 100 ? 'danger' : percentage > 80 ? 'warning' : 'success';
            
            historyHtml += `
              <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--bg-primary);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <strong>${monthName}</strong>
                  <span class="badge ${statusClass}" style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${status}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span>Budget: ${formatCurrency(monthBudget.budget)}</span>
                  <span>Spent: ${formatCurrency(monthExpenses)}</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; width: ${Math.min(percentage, 100)}%; background: ${statusClass === 'success' ? '#4CAF50' : statusClass === 'warning' ? '#ff9800' : '#f44336'}; border-radius: 3px;"></div>
                </div>
                <small style="color: var(--text-secondary);">${Math.round(percentage)}% used</small>
              </div>
            `;
          });
        }
        
        historyHtml += '</div>';
        
        // Create and show modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px; margin: auto;">
            <div class="modal-header">
              <h3>üìà Budget History</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
              ${historyHtml}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // Hamburger Menu Functions
      function toggleHamburgerMenu() {
        const dropdown = document.getElementById("hamburgerDropdown");
        const hamburgerBtn = document.getElementById("hamburgerBtn");

        if (dropdown.classList.contains("active")) {
          dropdown.classList.remove("active");
          hamburgerBtn.classList.remove("active");
        } else {
          dropdown.classList.add("active");
          hamburgerBtn.classList.add("active");
        }
      }

      // Close hamburger menu when clicking outside
      document.addEventListener("click", function (event) {
        const dropdown = document.getElementById("hamburgerDropdown");
        const hamburgerBtn = document.getElementById("hamburgerBtn");

        if (
          !hamburgerBtn.contains(event.target) &&
          !dropdown.contains(event.target)
        ) {
          dropdown.classList.remove("active");
          hamburgerBtn.classList.remove("active");
        }
      });

      // Close hamburger menu when clicking menu items
      document.addEventListener("click", function (event) {
        if (event.target.closest(".hamburger-menu-item")) {
          const dropdown = document.getElementById("hamburgerDropdown");
          const hamburgerBtn = document.getElementById("hamburgerBtn");
          dropdown.classList.remove("active");
          hamburgerBtn.classList.remove("active");
        }
      });

      // Premium feature check function
      function checkPremiumFeature(feature) {
        // For now, just show a toast message
        if (window.app && window.app.showToast) {
          window.app.showToast("Fitur Premium - Coming Soon!", "info");
        } else {
          console.log("Premium feature:", feature);
        }
        return false;
      }

      // Navigation functions
      function navigateToAddTransaction() {
        console.log("Navigating to Add Transaction page...");

        // Add visual feedback
        const button = event.target.closest("button");
        if (button) {
          button.style.transform = "scale(0.95)";
          setTimeout(() => {
            button.style.transform = "";
          }, 150);
        }

        // Show loading state briefly
        if (window.app && window.app.showToast) {
          window.app.showToast("Opening Add Transaction...", "info");
        }

        // Navigate with small delay for visual feedback
        setTimeout(() => {
          try {
            window.location.href = "add-transaction.html";
          } catch (error) {
            console.error("Navigation error:", error);
            if (window.app && window.app.showToast) {
              window.app.showToast(
                "Navigation failed, please try again",
                "error"
              );
            }
          }
        }, 200);
      }

      // Backup event listener for buttons with data-action
      document.addEventListener("click", function (event) {
        const target = event.target.closest("[data-action]");
        if (!target) return;

        const action = target.getAttribute("data-action");
        const type = target.getAttribute("data-type");

        console.log(`Button clicked: action=${action}, type=${type}`);

        if (action === "quick-add") {
          navigateToAddTransaction();
        }
      });

      // Update dashboard metrics
      function updateDashboardMetrics() {
        const transactions = JSON.parse(
          localStorage.getItem("transactions") || "[]"
        );
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();

        // Calculate current month data
        const currentMonthTransactions = transactions.filter((t) => {
          const transDate = new Date(t.date);
          return (
            transDate.getMonth() === currentMonth &&
            transDate.getFullYear() === currentYear
          );
        });

        const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const prevMonthTransactions = transactions.filter((t) => {
          const transDate = new Date(t.date);
          return (
            transDate.getMonth() === prevMonth &&
            transDate.getFullYear() === prevYear
          );
        });

        // Calculate totals
        const currentIncome = currentMonthTransactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);

        const currentExpenses = currentMonthTransactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);

        const prevIncome = prevMonthTransactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);

        const prevExpenses = prevMonthTransactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);

        const balance = currentIncome - currentExpenses;
        const savingsRate =
          currentIncome > 0
            ? ((currentIncome - currentExpenses) / currentIncome) * 100
            : 0;

        // Calculate changes
        const incomeChange =
          prevIncome > 0
            ? ((currentIncome - prevIncome) / prevIncome) * 100
            : 0;
        const expenseChange =
          prevExpenses > 0
            ? ((currentExpenses - prevExpenses) / prevExpenses) * 100
            : 0;

        // Update UI with null checks
        const balanceEl = document.getElementById("dashboardBalance");
        const incomeEl = document.getElementById("monthIncome");
        const expenseEl = document.getElementById("monthExpense");
        const savingsEl = document.getElementById("savingsRate");
        const dateEl = document.getElementById("dashboardDate");

        if (balanceEl) balanceEl.textContent = formatCurrency(balance);
        if (incomeEl) incomeEl.textContent = formatCurrency(currentIncome);
        if (expenseEl) expenseEl.textContent = formatCurrency(currentExpenses);
        if (savingsEl) savingsEl.textContent = savingsRate.toFixed(1) + "%";

        // Update change indicators
        updateChangeIndicator("incomeChange", incomeChange);
        updateChangeIndicator("expenseChange", expenseChange);

        // Update dashboard date
        if (dateEl) dateEl.textContent = formatDate(new Date());
      }

      function updateChangeIndicator(elementId, change) {
        const element = document.getElementById(elementId);
        if (!element) {
          console.warn(`Change indicator element '${elementId}' not found`);
          return;
        }

        const absChange = Math.abs(change);
        element.textContent = `${change >= 0 ? "+" : ""}${change.toFixed(1)}%`;

        element.className = `metric-change ${
          change >= 0 ? "positive" : "negative"
        }`;
      }

      // Update recent activity
      function updateRecentActivity() {
        const transactions = JSON.parse(
          localStorage.getItem("transactions") || "[]"
        );
        const recentTransactions = transactions
          .sort(
            (a, b) =>
              new Date(b.date + " " + (b.time || "00:00")) -
              new Date(a.date + " " + (a.time || "00:00"))
          )
          .slice(0, 5);

        const activityContainer = document.getElementById("recentActivity");

        if (!activityContainer) {
          console.warn("Activity container element not found");
          return;
        }

        if (recentTransactions.length === 0) {
          activityContainer.innerHTML = `
            <div class="empty-activity">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>
              </svg>
              <p>No recent activity</p>
            </div>
          `;
          return;
        }

        activityContainer.innerHTML = recentTransactions
          .map(
            (transaction) => `
          <div class="activity-item">
            <div class="activity-icon ${transaction.type}">
              ${transaction.type === "income" ? "üìà" : "üìâ"}
            </div>
            <div class="activity-info">
              <div class="activity-title">${getCategoryName(
                transaction.type,
                transaction.category
              )}</div>
              <div class="activity-details">${
                transaction.description || "No description"
              }</div>
            </div>
            <div style="text-align: right;">
              <div class="activity-amount ${transaction.type}">${formatCurrency(
              transaction.amount
            )}</div>
              <div class="activity-time">${formatRelativeTime(
                transaction.date,
                transaction.time
              )}</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Update budget overview
      function updateBudgetOverview() {
        const budget = JSON.parse(localStorage.getItem("budget") || "{}");
        const currentDate = new Date();
        const currentMonthKey = `${currentDate.getFullYear()}-${String(
          currentDate.getMonth() + 1
        ).padStart(2, "0")}`;
        const monthlyBudget = budget[currentMonthKey];

        const budgetContainer = document.getElementById("budgetOverview");

        // Check if element exists
        if (!budgetContainer) {
          console.warn("Budget container element not found");
          return;
        }

        if (!monthlyBudget) {
          budgetContainer.innerHTML = `
            <div class="budget-empty-state">
              <div class="budget-empty-icon">üí∏</div>
              <h3 class="budget-empty-title">No Budget Set</h3>
              <p class="budget-empty-description">
                Start managing your finances better by setting up a monthly budget. 
                Track your spending and stay on top of your financial goals.
              </p>
              <button class="btn-modern-primary" onclick="showBudgetModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                <span>Create Budget</span>
              </button>
            </div>
          `;
          return;
        }

        const transactions = JSON.parse(
          localStorage.getItem("transactions") || "[]"
        );
        const currentExpenses = transactions
          .filter((t) => {
            const transDate = new Date(t.date);
            return (
              t.type === "expense" &&
              transDate.getMonth() === currentDate.getMonth() &&
              transDate.getFullYear() === currentDate.getFullYear()
            );
          })
          .reduce((sum, t) => sum + t.amount, 0);

        const percentage = monthlyBudget.budget > 0 ? (currentExpenses / monthlyBudget.budget) * 100 : 0;
        const remaining = monthlyBudget.budget - currentExpenses;
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        const daysPassed = currentDate.getDate();
        const expectedSpent = (monthlyBudget.budget / daysInMonth) * daysPassed;
        
        // Determine status
        let status = 'on-track';
        if (percentage > 100) status = 'over-budget';
        else if (percentage > 80 || currentExpenses > expectedSpent * 1.2) status = 'warning';
        
        budgetContainer.innerHTML = `
          <div class="budget-cards-grid">
            <div class="budget-card-modern ${status}">
              <div class="budget-card-header">
                <h3 class="budget-card-title">üìä Monthly Budget</h3>
                <span class="budget-status-badge ${status}">
                  ${status === 'on-track' ? 'On Track' : status === 'warning' ? 'Warning' : 'Over Budget'}
                </span>
              </div>
              
              <div class="budget-progress-section">
                <div class="budget-amounts">
                  <span class="budget-spent">${formatCurrency(currentExpenses)}</span>
                  <span class="budget-total">of ${formatCurrency(monthlyBudget.budget)}</span>
                </div>
                <div class="budget-progress-bar">
                  <div class="budget-progress-fill ${status}" style="width: ${Math.min(percentage, 100)}%"></div>
                </div>
              </div>
              
              <div class="budget-summary-stats">
                <div class="budget-stat">
                  <div class="budget-stat-value">${formatCurrency(Math.abs(remaining))}</div>
                  <div class="budget-stat-label">${remaining >= 0 ? 'Remaining' : 'Over'}</div>
                </div>
                <div class="budget-stat">
                  <div class="budget-stat-value">${Math.round(percentage)}%</div>
                  <div class="budget-stat-label">Used</div>
                </div>
                <div class="budget-stat">
                  <div class="budget-stat-value">${daysInMonth - daysPassed}</div>
                  <div class="budget-stat-label">Days Left</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Update smart insights
      function updateSmartInsights() {
        const transactions = JSON.parse(
          localStorage.getItem("transactions") || "[]"
        );
        const insights = generateFinancialInsights(transactions);

        const insightsContainer = document.getElementById("smartInsights");

        if (!insightsContainer) {
          console.warn("Insights container element not found");
          return;
        }

        if (insights.length === 0) {
          insightsContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 1rem; opacity: 0.5;">
                <path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4m6-6h4a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-4m-6 0a2 2 0 0 0-2-2v-3a2 2 0 0 0 2-2m6 0a2 2 0 0 1 2-2v-3a2 2 0 0 1-2-2"/>
              </svg>
              <p>Add some transactions to see insights</p>
            </div>
          `;
          return;
        }

        insightsContainer.innerHTML = insights
          .map(
            (insight) => `
          <div class="insight-item">
            <div class="insight-icon">${insight.icon}</div>
            <div class="insight-content">
              <div class="insight-title">${insight.title}</div>
              <div class="insight-description">${insight.description}</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Generate financial insights
      function generateFinancialInsights(transactions) {
        const insights = [];
        const currentDate = new Date();

        // Get current month transactions
        const currentMonthTransactions = transactions.filter((t) => {
          const transDate = new Date(t.date);
          return (
            transDate.getMonth() === currentDate.getMonth() &&
            transDate.getFullYear() === currentDate.getFullYear()
          );
        });

        const expenses = currentMonthTransactions.filter(
          (t) => t.type === "expense"
        );

        if (expenses.length > 0) {
          // Find highest expense category
          const categoryTotals = {};
          expenses.forEach((t) => {
            categoryTotals[t.category] =
              (categoryTotals[t.category] || 0) + t.amount;
          });

          const highestCategory = Object.entries(categoryTotals).sort(
            ([, a], [, b]) => b - a
          )[0];

          if (highestCategory) {
            insights.push({
              icon: "üìä",
              title: "Top Expense Category",
              description: `${getCategoryName(
                "expense",
                highestCategory[0]
              )} accounts for ${formatCurrency(
                highestCategory[1]
              )} of your spending this month.`,
            });
          }

          // Average daily spending
          const daysInMonth = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth() + 1,
            0
          ).getDate();
          const currentDay = currentDate.getDate();
          const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
          const avgDaily = totalExpenses / currentDay;
          const projectedMonthly = avgDaily * daysInMonth;

          insights.push({
            icon: "üìà",
            title: "Spending Projection",
            description: `At your current pace, you'll spend ${formatCurrency(
              projectedMonthly
            )} this month (${formatCurrency(avgDaily)} per day).`,
          });
        }

        // Savings insight
        const income = currentMonthTransactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);
        const totalExpenses = currentMonthTransactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);

        if (income > 0) {
          const savingsRate = ((income - totalExpenses) / income) * 100;
          const icon =
            savingsRate >= 20 ? "üéØ" : savingsRate >= 10 ? "üí°" : "‚ö†Ô∏è";
          const message =
            savingsRate >= 20
              ? "Great job!"
              : savingsRate >= 10
              ? "Good progress!"
              : "Consider reducing expenses.";

          insights.push({
            icon: icon,
            title: "Savings Rate",
            description: `You're saving ${savingsRate.toFixed(
              1
            )}% of your income this month. ${message}`,
          });
        }

        return insights;
      }

      // Update profile preview
      function updateProfilePreview() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const transactions = JSON.parse(
          localStorage.getItem("transactions") || "[]"
        );

        const profileContainer = document.getElementById("profilePreview");

        if (!profileContainer) {
          console.warn("Profile container element not found");
          return;
        }

        const totalTransactions = transactions.length;
        const daysSinceJoined = Math.floor(
          (Date.now() - new Date(user.joinDate || Date.now()).getTime()) /
            (1000 * 60 * 60 * 24)
        );

        profileContainer.innerHTML = `
          <div class="profile-avatar-mini">üë§</div>
          <div class="profile-name">${user.name || "Pengguna Tamu"}</div>
          <div class="profile-stats-mini">
            <div class="profile-stat-mini">
              <div class="profile-stat-value">${totalTransactions}</div>
              <div class="profile-stat-label">Transactions</div>
            </div>
            <div class="profile-stat-mini">
              <div class="profile-stat-value">${daysSinceJoined}</div>
              <div class="profile-stat-label">Days Active</div>
            </div>
          </div>
        `;
      }

      // Utility functions
      function formatCurrency(amount) {
        if (window.Utils && window.Utils.formatCurrency) {
          return window.Utils.formatCurrency(amount);
        }

        // Enhanced formatting for large numbers with better mobile display
        const absAmount = Math.abs(amount);
        const isNegative = amount < 0;
        const sign = isNegative ? "-" : "";

        // For very large amounts, use shortened format on mobile screens
        if (window.innerWidth <= 480 && absAmount >= 1000000) {
          if (absAmount >= 1000000000) {
            return `${sign}Rp ${(absAmount / 1000000000).toFixed(1)}M`;
          } else if (absAmount >= 1000000) {
            return `${sign}Rp ${(absAmount / 1000000).toFixed(1)}jt`;
          }
        }

        return `Rp ${amount.toLocaleString("id-ID")}`;
      }

      function formatDate(date) {
        return new Intl.DateTimeFormat("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
        }).format(date);
      }

      function formatRelativeTime(date, time = "00:00") {
        const transactionDate = new Date(date + " " + time);
        const now = new Date();
        const diffMs = now - transactionDate;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return "Today";
        if (diffDays === 1) return "Yesterday";
        if (diffDays < 7) return `${diffDays} days ago`;
        return transactionDate.toLocaleDateString("id-ID");
      }

      function getCategoryName(type, category) {
        // Default categories fallback
        const defaultCategories = {
          expense: {
            makanan: { name: "Makanan & Minuman", icon: "üçΩÔ∏è" },
            transportasi: { name: "Transportasi", icon: "üöó" },
            belanja: { name: "Belanja", icon: "üõí" },
            hiburan: { name: "Hiburan", icon: "üé¨" },
            kesehatan: { name: "Kesehatan", icon: "üè•" },
            pendidikan: { name: "Pendidikan", icon: "üìö" },
            tagihan: { name: "Tagihan", icon: "üí≥" },
            lainnya: { name: "Lainnya", icon: "üìù" },
          },
          income: {
            gaji: { name: "Gaji", icon: "üí∞" },
            freelance: { name: "Freelance", icon: "üíª" },
            bisnis: { name: "Bisnis", icon: "üè¢" },
            investasi: { name: "Investasi", icon: "üìà" },
            hadiah: { name: "Hadiah", icon: "üéÅ" },
            lainnya: { name: "Lainnya", icon: "üíµ" },
          },
        };

        // Try to get from app categories first
        if (
          window.app &&
          window.app.categories &&
          window.app.categories[type] &&
          window.app.categories[type][category]
        ) {
          const cat = window.app.categories[type][category];
          return `${cat.icon || ""} ${cat.name}`;
        }

        // Fallback to default categories
        if (defaultCategories[type] && defaultCategories[type][category]) {
          const cat = defaultCategories[type][category];
          return `${cat.icon || ""} ${cat.name}`;
        }

        // Final fallback
        return category || "Unknown";
      }

      // Initialize dashboard data when loaded
      let dashboardInitialized = false;

      function checkRequiredElements() {
        const requiredElements = [
          "dashboardBalance",
          "monthIncome",
          "monthExpense",
          "savingsRate",
          "recentActivity",
          "budgetOverview",
          "smartInsights",
          "profilePreview",
        ];

        for (let elementId of requiredElements) {
          if (!document.getElementById(elementId)) {
            console.warn(`Required element '${elementId}' not found`);
            return false;
          }
        }
        return true;
      }

      function initializeDashboard() {
        if (dashboardInitialized) {
          console.log("Dashboard already initialized, skipping...");
          return;
        }

        if (!checkRequiredElements()) {
          console.warn("Not all required elements found, retrying in 200ms...");
          setTimeout(initializeDashboard, 200);
          return;
        }

        console.log("Initializing dashboard...");
        dashboardInitialized = true;

        updateDashboardMetrics();
        updateRecentActivity();
        updateBudgetOverview();
        updateSmartInsights();
        updateProfilePreview();
      } // Enhanced initialization
      document.addEventListener("DOMContentLoaded", function () {
        // Set up service worker
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", function () {
            navigator.serviceWorker
              .register("sw.js")
              .then(function (registration) {
                console.log("SW registered with scope: ", registration.scope);
              })
              .catch(function (err) {
                console.log("SW registration failed: ", err);
              });
          });
        }

        // Ensure ExpenseTracker is loaded before using it
        function initializeApp() {
          if (window.ExpenseTracker && !window.app) {
            console.log("Setting up ExpenseTracker...");
            window.app = window.ExpenseTracker;
            window.app.init();
            // Show only dashboard section
            window.app.showSection("dashboard");
            // Initialize dashboard-specific data with a longer delay to ensure DOM is fully ready
            setTimeout(initializeDashboard, 500);
          } else if (window.app) {
            // App already initialized, just initialize dashboard
            setTimeout(initializeDashboard, 300);
          } else {
            console.warn("ExpenseTracker not found, retrying...");
            setTimeout(initializeApp, 300);
          }
        }

        // Wait for full DOM ready state
        if (document.readyState === "loading") {
          // DOM is still loading, wait for it
          console.log("DOM still loading, waiting...");
        } else {
          // DOM is already ready
          console.log("DOM ready, initializing app...");
        }

        initializeApp();
      });
    </script>
  </body>
</html>
